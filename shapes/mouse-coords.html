<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>LibCanvas :: moving layers</title>
		<link href="/files/styles.css" rel="stylesheet" />
		<script src="/files/js/atom.js"></script>
		<script src="/files/js/libcanvas.js"></script>
	</head>
	<body>
		<canvas></canvas>
		<p>Drag the map</p>
		<p><a href="/">Return to index</a></p>
		<script>
(function (buildings) {
	LibCanvas.extract();

	buildings = function (rows, cells) {
		var full = [], x, y;

		for (y = rows; y--;) for (x = cells; x--;) {
			buildings.forEach(function (b) {
				full.push([
					b[0],
					b[1] + x*10,
					b[2] + y*10
				]);
			});
		}

		return full;
	}(2, 5);


	var app = new LibCanvas.App('canvas', {
		width : 1000,
		height: 500,
		mouse : true,
		preloadImages: {
			'silo'   : '/files/img/dune.png [0:0:100:100]',
			'factory': '/files/img/dune.png [0:100:150:100]',
			'harvest': '/files/img/dune.png [0:200:150:100]',
			'radar'  : '/files/img/dune.png [0:300:100:100]',
			'power'  : '/files/img/dune.png [0:400:100:100]',
			'plate'  : '/files/img/dune.png [0:500:50:50]',
			'sand'   : '/files/img/dune.png [0:550:100:100]'
		}
	}).ready(function () {
		var scene = app.createScene({ intersection: 'manual' });
		scene.libcanvas.size( 2550, 1050 );

		var ctx = scene.libcanvas.ctx;
		ctx.fillAll(ctx.createPattern( scene.resources.getImage('sand'), 'repeat' ));

		buildings = buildings.map(function (args, i) {
			return new Element( scene, {
				from  : new Point(args[1]*50, args[2]*50),
				x     : args[1],
				y     : args[2],
				image : scene.resources.getImage(args[0]),
				index : i,
				zIndex: i
			})
			.clickable()
			.addEvent( 'statusChanged', function () {
				this.redraw();
			});
		});

		var drag  = null;

		new Trace( 'Buildings: ' + buildings.length );

		var stopDrag = function () {
			if (drag) {
				var start = Date.now();
				scene.resources.mouse.start();
				scene.addElementsShift(drag);
				scene.start();
				new Trace( Date.now() - start );
			}
			drag = null;
		};

		app.libcanvas.mouse.addEvent({
			'down': function () {
				scene.resources.mouse.stop();
				scene.stop();
				drag = new Point(0, 0);
			},
			'up'  : stopDrag,
			'out' : stopDrag,
			'move': function (e) {
				if (!drag) return;
				drag.move( e.deltaOffset );
				scene.addShift( e.deltaOffset );
			}
		});
	});

	var Element = atom.Class({
		Extends: LibCanvas.Scene.Element,

		Implements: Clickable,

		initialize: function (scene, options) {
			this.shape = new Rectangle({ from: options.from, size: options.image });
			this.parent( scene, options );
		},

		renderTo: function (ctx) {
			var o = this.options;
			ctx.drawImage({
				image: o.image,
				draw : this.shape,
				optimize: true
			});
			var shape = this.shape.clone();
			shape.from.move([0.5, 0.5]);
			shape.to.move([-0.5, -0.5]);
			if (this.hover) {
				ctx.stroke( shape, 'red' );
				ctx.text({
					color: 'white',
					text : o.index + ':' + o.x + '*' + o.y,
					overflow: 'hidden',
					to   : shape,
					shadow : '0 0 1 black',
					size   : 10,
					padding: 2
				});
			}
		}
	});
}([
	[ 'silo'   ,   1,   1 ],
	[ 'plate'  ,   3,   1 ],
	[ 'plate'  ,   4,   1 ],
	[ 'plate'  ,   5,   1 ],
	[ 'plate'  ,   6,   1 ],
	[ 'plate'  ,   7,   1 ],
	[ 'plate'  ,   8,   1 ],
	[ 'plate'  ,   9,   1 ],
	[ 'plate'  ,   3,   2 ],
	[ 'plate'  ,   1,   3 ],
	[ 'plate'  ,   2,   3 ],
	[ 'plate'  ,   3,   3 ],
	[ 'factory',   4,   2 ],
	[ 'plate'  ,   3,   4 ],
	[ 'plate'  ,   3,   5 ],
	[ 'radar'  ,   1,   4 ],
	[ 'plate'  ,   4,   4 ],
	[ 'plate'  ,   5,   4 ],
	[ 'plate'  ,   6,   4 ],
	[ 'plate'  ,   7,   4 ],
	[ 'plate'  ,   8,   4 ],
	[ 'plate'  ,   9,   4 ],
	[ 'power'  ,   4,   5 ],
	[ 'power'  ,   6,   5 ],
	[ 'power'  ,   8,   5 ],
	[ 'harvest',   7,   2 ],
	[ 'silo'   ,   1,   6 ],
	[ 'silo'   ,   1,   8 ],
	[ 'plate'  ,   3,   6 ],
	[ 'plate'  ,   3,   7 ],
	[ 'plate'  ,   4,   7 ],
	[ 'plate'  ,   5,   7 ],
	[ 'plate'  ,   6,   7 ],
	[ 'plate'  ,   7,   7 ],
	[ 'plate'  ,   8,   7 ],
	[ 'plate'  ,   9,   7 ],
	[ 'plate'  ,   3,   8 ],
	[ 'plate'  ,   3,   9 ],
	[ 'plate'  ,   7,   8 ],
	[ 'harvest',   4,   8 ]
]));
		</script>
		<script src="/files/js/google-analytics.js"></script>
	</body>
</html>